(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-chat-session"],{"08aa":function(e,t,n){"use strict";n.r(t);var a=n("68c6"),r=n("c790");for(var s in r)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(s);n("7457");var i=n("828b"),o=Object(i["a"])(r["default"],a["b"],a["c"],!1,null,"6e6a6785",null,!1,a["a"],void 0);t["default"]=o.exports},"0b09":function(e,t,n){var a=n("2d58");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var r=n("967d").default;r("1e763777",a,!0,{sourceMap:!1,shadowMode:!1})},"0bea":function(e,t,n){"use strict";n("6a54");var a=n("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=a(n("b7c7"));n("64aa"),n("4100"),n("795c"),n("c223");var s={props:{messages:{type:Array,default:function(){return[]}},currentUserId:{type:Number,default:null}},computed:{orderedMessages:function(){return(0,r.default)(this.messages).sort((function(e,t){return new Date(e.created_at)-new Date(t.created_at)}))},lastItemId:function(){if(!this.orderedMessages.length)return"";var e=this.orderedMessages[this.orderedMessages.length-1];return"msg-".concat(e.client_msg_id||e.message_id||e.created_at)}},methods:{isOwn:function(e){return this.currentUserId&&e.from_user_id===this.currentUserId},formatTime:function(e){if(!e)return"";try{var t=new Date(e),n="".concat(t.getHours()).padStart(2,"0"),a="".concat(t.getMinutes()).padStart(2,"0");return"".concat(n,":").concat(a)}catch(r){return""}}}};t.default=s},1060:function(e,t,n){"use strict";n.r(t);var a=n("4eba"),r=n("e522");for(var s in r)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(s);n("62dd");var i=n("828b"),o=Object(i["a"])(r["default"],a["b"],a["c"],!1,null,"20665c8e",null,!1,a["a"],void 0);t["default"]=o.exports},"25b1":function(e,t,n){"use strict";n.r(t);var a=n("dd6a"),r=n("4996");for(var s in r)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(s);n("dfd3");var i=n("828b"),o=Object(i["a"])(r["default"],a["b"],a["c"],!1,null,"c83300ac",null,!1,a["a"],void 0);t["default"]=o.exports},"2d58":function(e,t,n){var a=n("c86c");t=a(!1),t.push([e.i,".msg-list[data-v-c83300ac]{height:100%;padding:12px;box-sizing:border-box}.msg-row[data-v-c83300ac]{display:flex;margin-bottom:10px}.msg-row.peer[data-v-c83300ac]{justify-content:flex-start}.msg-row.self[data-v-c83300ac]{justify-content:flex-end}.bubble[data-v-c83300ac]{max-width:80%;padding:10px 12px;border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.08);position:relative}.msg-row.self .bubble[data-v-c83300ac]{background:#2b7bff;color:#fff}.media-placeholder[data-v-c83300ac]{color:#6b7280;font-size:12px}.time[data-v-c83300ac]{display:block;margin-top:6px;font-size:11px;color:#9ca3af}",""]),e.exports=t},"3bdf":function(e,t,n){var a=n("c86c");t=a(!1),t.push([e.i,".page[data-v-20665c8e]{display:flex;flex-direction:column;height:100vh}.header[data-v-20665c8e]{padding:10px 12px;background:#fff;border-bottom:1px solid #e5e7eb}.title[data-v-20665c8e]{font-size:18px;font-weight:600}.sub[data-v-20665c8e]{font-size:12px;color:#9ca3af}.body[data-v-20665c8e]{flex:1;overflow:hidden}",""]),e.exports=t},"485c":function(e,t,n){var a=n("c86c");t=a(!1),t.push([e.i,".input-bar[data-v-6e6a6785]{display:flex;padding:8px;background:#fff;border-top:1px solid #e5e7eb}.textarea[data-v-6e6a6785]{flex:1;min-height:40px;padding:8px;border:1px solid #e5e7eb;border-radius:6px;box-sizing:border-box}.send-btn[data-v-6e6a6785]{margin-left:8px;background:#2b7bff;color:#fff;padding:10px 14px;border-radius:6px;font-size:14px}",""]),e.exports=t},4966:function(e,t,n){var a=n("485c");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var r=n("967d").default;r("4e936210",a,!0,{sourceMap:!1,shadowMode:!1})},4996:function(e,t,n){"use strict";n.r(t);var a=n("0bea"),r=n.n(a);for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);t["default"]=r.a},"4eba":function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-view",{staticClass:"page"},[n("v-uni-view",{staticClass:"header"},[n("v-uni-view",{staticClass:"title"},[e._v(e._s(e.peerName||"聊天"))]),n("v-uni-view",{staticClass:"sub"},[e._v("ID: "+e._s(e.peerId))])],1),n("v-uni-view",{staticClass:"body"},[n("MessageList",{attrs:{messages:e.messages,currentUserId:e.currentUserId}})],1),n("MessageInput",{on:{send:function(t){arguments[0]=t=e.$handleEvent(t),e.handleSend.apply(void 0,arguments)}}})],1)},r=[]},"62dd":function(e,t,n){"use strict";var a=n("8a42"),r=n.n(a);r.a},"68c6":function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-view",{staticClass:"input-bar"},[n("v-uni-textarea",{staticClass:"textarea",attrs:{placeholder:"说点什么...","auto-height":!0,"confirm-type":"send"},on:{confirm:function(t){arguments[0]=t=e.$handleEvent(t),e.handleSend.apply(void 0,arguments)}},model:{value:e.text,callback:function(t){e.text=t},expression:"text"}}),n("v-uni-view",{staticClass:"send-btn",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.handleSend.apply(void 0,arguments)}}},[e._v("发送")])],1)},r=[]},"73e1":function(e,t,n){"use strict";var a=n("29d8");e.exports=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(a)},7457:function(e,t,n){"use strict";var a=n("4966"),r=n.n(a);r.a},"795c":function(e,t,n){"use strict";var a=n("8bdb"),r=n("db04").start,s=n("73e1");a({target:"String",proto:!0,forced:s},{padStart:function(e){return r(this,e,arguments.length>1?arguments[1]:void 0)}})},"866e":function(e,t,n){"use strict";n("6a54");var a=n("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,n("64aa"),n("bf0f");var r=a(n("2634")),s=a(n("2fdc")),i=a(n("25b1")),o=a(n("08aa")),c={components:{MessageList:i.default,MessageInput:o.default},data:function(){return{peerId:null,peerName:"",loadingMore:!1}},computed:{session:function(){return this.$store.state.messages.sessions[this.peerId]||{items:[],before:null}},messages:function(){return this.session.items||[]},currentUserId:function(){var e;return null===(e=this.$store.state.auth.user)||void 0===e?void 0:e.id}},onLoad:function(e){var t=this;return(0,s.default)((0,r.default)().mark((function n(){return(0,r.default)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.peerId=Number(e.peer),t.peerName=decodeURIComponent(e.name||""),t.peerId){n.next=6;break}return uni.showToast({title:"缺少对话用户",icon:"none"}),uni.navigateBack(),n.abrupt("return");case 6:return n.next=8,t.$store.dispatch("connectWs");case 8:return n.next=10,t.loadInitial();case 10:case"end":return n.stop()}}),n)})))()},onPullDownRefresh:function(){this.loadMore().finally((function(){return uni.stopPullDownRefresh()}))},methods:{loadInitial:function(){var e=this;return(0,s.default)((0,r.default)().mark((function t(){return(0,r.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("messages/fetchHistory",{peerId:e.peerId,limit:30});case 2:e.$store.dispatch("messages/clearUnread",e.peerId);case 3:case"end":return t.stop()}}),t)})))()},loadMore:function(){var e=this;return(0,s.default)((0,r.default)().mark((function t(){return(0,r.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.loadingMore){t.next=2;break}return t.abrupt("return");case 2:return e.loadingMore=!0,t.prev=3,t.next=6,e.$store.dispatch("messages/fetchHistory",{peerId:e.peerId,limit:30,before:e.session.before});case 6:return t.prev=6,e.loadingMore=!1,t.finish(6);case 9:case"end":return t.stop()}}),t,null,[[3,,6,9]])})))()},handleSend:function(e){var t=this;return(0,s.default)((0,r.default)().mark((function n(){var a;return(0,r.default)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a="c_".concat(Date.now()),n.next=3,t.$store.dispatch("messages/sendMessage",{peerId:t.peerId,content:e,clientMsgId:a});case 3:case"end":return n.stop()}}),n)})))()}}};t.default=c},"8a42":function(e,t,n){var a=n("3bdf");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var r=n("967d").default;r("3fda770e",a,!0,{sourceMap:!1,shadowMode:!1})},a7bf:function(e,t,n){"use strict";n("6a54"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,n("0c26");t.default={data:function(){return{text:""}},methods:{handleSend:function(){var e=this.text.trim();e&&(this.$emit("send",e),this.text="")}}}},c790:function(e,t,n){"use strict";n.r(t);var a=n("a7bf"),r=n.n(a);for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);t["default"]=r.a},db04:function(e,t,n){"use strict";var a=n("bb80"),r=n("c435"),s=n("9e70"),i=n("f298"),o=n("862c"),c=a(i),u=a("".slice),d=Math.ceil,f=function(e){return function(t,n,a){var i,f,l=s(o(t)),p=r(n),v=l.length,b=void 0===a?" ":s(a);return p<=v||""===b?l:(i=p-v,f=c(b,d(i/b.length)),f.length>i&&(f=u(f,0,i)),e?l+f:f+l)}};e.exports={start:f(!1),end:f(!0)}},dd6a:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-uni-scroll-view",{staticClass:"msg-list",attrs:{"scroll-y":!0,"scroll-into-view":e.lastItemId}},e._l(e.orderedMessages,(function(t){return n("v-uni-view",{key:t.client_msg_id||t.message_id||t.created_at,staticClass:"msg-row",class:e.isOwn(t)?"self":"peer",attrs:{id:"msg-"+(t.client_msg_id||t.message_id||t.created_at)}},[n("v-uni-view",{staticClass:"bubble"},["text"===t.content_type?n("v-uni-text",[e._v(e._s(t.content))]):n("v-uni-view",{staticClass:"media-placeholder"},[e._v("媒体消息占位")]),n("v-uni-text",{staticClass:"time"},[e._v(e._s(e.formatTime(t.created_at)))])],1)],1)})),1)},r=[]},dfd3:function(e,t,n){"use strict";var a=n("0b09"),r=n.n(a);r.a},e522:function(e,t,n){"use strict";n.r(t);var a=n("866e"),r=n.n(a);for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);t["default"]=r.a},f298:function(e,t,n){"use strict";var a=n("497b"),r=n("9e70"),s=n("862c"),i=RangeError;e.exports=function(e){var t=r(s(this)),n="",o=a(e);if(o<0||o===1/0)throw new i("Wrong number of repetitions");for(;o>0;(o>>>=1)&&(t+=t))1&o&&(n+=t);return n}}}]);